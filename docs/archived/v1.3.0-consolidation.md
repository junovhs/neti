# SlopChop v1.3 Consolidation Plan

**Document Type:** Implementation Specification  
**Created:** 2025-12-28  
**Purpose:** Provide complete context for any AI to execute the v1.3 consolidation

---

# Executive Summary

SlopChop is a structural governance tool for AI-generated codebases. It enforces constraints (file size, complexity, safety patterns) and provides a staged ingestion system for applying AI-generated code changes safely.

**The v1.3 release is a consolidation release.** No new features. The goals are:
1. Fix self-violations (SlopChop must pass its own checks)
2. Remove dead/redundant code
3. Harden what remains
4. Make violations actionable

---

# Section 1: Project Context

## 1.1 What SlopChop Is

A CLI tool written in Rust that:
- **Scans** code for structural violations (The Three Laws)
- **Gates** commits by running external commands + internal scans
- **Applies** AI-generated code via a staged transaction system
- **Packs** repository context for AI consumption

## 1.2 The Three Laws

1. **Law of Atomicity:** Files must be < 2000 tokens
2. **Law of Complexity:** Cyclomatic complexity ≤ 8, nesting ≤ 3, function args ≤ 5
3. **Law of Paranoia:** No `.unwrap()` or `.expect()` in production code

## 1.3 The Fourth Law (Experimental)

4. **Law of Locality:** Dependencies must respect topological distance (D ≤ 4 for non-hubs)

This law is implemented but not yet validated in production. It should remain in advisory mode (`mode = "warn"`) until thresholds are confirmed.

## 1.4 The User

The primary user is a product designer who uses AI to generate code but cannot personally audit structural quality. SlopChop provides mechanical verification that the AI's output is sound.

**Workflow:**
1. AI generates code in chat
2. User runs `slopchop apply` (writes to stage)
3. Violations appear
4. User pastes violations back to AI
5. Repeat 2-6 times until clean
6. User runs `slopchop apply --promote` to commit

## 1.5 The XSC7XSC Protocol

AI outputs code wrapped in sigil markers:

```
XSC7XSC FILE XSC7XSC path/to/file.rs
// file content
XSC7XSC END XSC7XSC
```

This format is markdown-inert and shell-safe, preventing corruption by chat UIs.

---

# Section 2: Current State Analysis

## 2.1 Active Violation

```
FILE: src/apply/parser.rs | LAW OF ATOMICITY | File size is 2018 tokens (Limit: 2000)
```

This is a credibility blocker. Must be fixed first.

## 2.2 Command Inventory

| Command | Status | Action |
|---------|--------|--------|
| `scan` | Core | Keep |
| `check` | Core | Keep |
| `apply` | Core | Keep |
| `pack` | Core | Keep, absorb trace features |
| `trace` | Redundant | **Delete** |
| `fix` | Unused/risky | **Delete** |
| `prompt` | Not core | **Delete** (functionality exists via `pack --prompt`) |
| `dashboard` | Unused | **Delete or reduce to minimal** |
| `audit` | Experimental | Keep, mark experimental |
| `map` | Experimental | Keep, mark experimental |
| `signatures` | Experimental | Keep, mark experimental |

## 2.3 File Structure (Relevant Modules)

```
src/
├── apply/           # Core: staged ingestion
│   ├── mod.rs
│   ├── parser.rs    # VIOLATION: 2018 tokens
│   ├── executor.rs
│   ├── types.rs
│   └── verification.rs
├── pack/            # Core: context generation
│   ├── mod.rs
│   ├── focus.rs
│   └── formats.rs
├── trace/           # TO DELETE: redundant with pack
│   ├── mod.rs
│   ├── options.rs
│   ├── output.rs
│   └── runner.rs
├── cli/
│   ├── mod.rs
│   └── handlers.rs  # Command dispatch
├── analysis/        # Core: violation detection
├── graph/           # Locality support
├── audit/           # Experimental
├── signatures/      # Experimental
└── tui/             # Dashboard (to reduce/delete)
```

---

# Section 3: Implementation Tasks

## Task 1: Fix parser.rs Violation

**Priority:** BLOCKING  
**Effort:** Small  
**Files:** `src/apply/parser.rs`

The file is 2018 tokens. It needs to be under 2000.

**Approach:**
1. Identify logical boundaries in the parser
2. Extract a submodule (e.g., `parser/sanitize.rs` or `parser/blocks.rs`)
3. Verify token count after split

**Acceptance Criteria:**
- `slopchop scan` reports zero violations for `src/apply/parser.rs`
- All existing tests pass

---

## Task 2: Delete trace Module

**Priority:** High  
**Effort:** Small  
**Files to delete:**
- `src/trace/mod.rs`
- `src/trace/options.rs`
- `src/trace/output.rs`
- `src/trace/runner.rs`

**Files to modify:**
- `src/lib.rs` — remove `pub mod trace;`
- `src/cli/handlers.rs` — remove `handle_trace` function
- `src/cli/mod.rs` — remove `Trace` command variant
- `src/bin/slopchop.rs` — remove trace command dispatch

**Acceptance Criteria:**
- `cargo build` succeeds
- No references to `trace` module remain
- `slopchop trace` command no longer exists

---

## Task 3: Delete fix Command

**Priority:** High  
**Effort:** Small

**Files to modify:**
- `src/cli/handlers.rs` — remove `handle_fix` function
- `src/cli/mod.rs` — remove `Fix` command variant
- `src/bin/slopchop.rs` — remove fix command dispatch

**Note:** Keep the `[commands].fix` config option for now (it doesn't hurt), but remove the CLI surface.

**Acceptance Criteria:**
- `slopchop fix` command no longer exists
- `cargo build` succeeds

---

## Task 4: Delete prompt Command

**Priority:** Medium  
**Effort:** Small

The `prompt` command just generates the system prompt. This is already available via `slopchop pack --prompt`. The standalone command is redundant.

**Files to modify:**
- `src/cli/handlers.rs` — remove `handle_prompt` function
- `src/cli/mod.rs` — remove `Prompt` command variant
- `src/bin/slopchop.rs` — remove prompt command dispatch

**Note:** Keep `src/prompt/` module — it's used by pack.

**Acceptance Criteria:**
- `slopchop prompt` command no longer exists
- `slopchop pack --prompt` still works

---

## Task 5: Reduce or Delete Dashboard

**Priority:** Medium  
**Effort:** Medium

The TUI dashboard is feature-flagged (`features = ["tui"]`). Options:

**Option A (Recommended): Delete entirely**
- Remove `src/tui/` directory
- Remove `ratatui` and `crossterm` dependencies
- Remove `tui` feature flag
- Remove dashboard command

**Option B: Keep minimal config UI**
- Strip visualization features
- Keep only config editing
- This is more work for unclear value

**Files (if deleting):**
- Delete `src/tui/` entirely
- Modify `Cargo.toml` — remove tui deps and feature
- Modify `src/lib.rs` — remove `#[cfg(feature = "tui")] pub mod tui;`
- Modify `src/cli/` — remove dashboard command

**Acceptance Criteria:**
- `slopchop dashboard` command no longer exists (or is minimal)
- `cargo build` succeeds without tui feature

---

## Task 6: Set Locality to Advisory Mode by Default

**Priority:** High  
**Effort:** Trivial

**File:** `src/config/mod.rs` (or wherever defaults are set)

Change the default for `rules.locality.mode` from `"error"` to `"warn"`.

**Also update:**
- `docs/software-topology-brief.md` — note that locality is advisory by default
- `README.md` — clarify locality is experimental

**Acceptance Criteria:**
- Fresh `slopchop.toml` generation has `mode = "warn"` for locality
- Locality violations print warnings but don't fail `slopchop check`

---

## Task 7: Make Violations Prescriptive

**Priority:** High  
**Effort:** Medium-Large

Current violation output:
```
FILE: src/foo.rs | LAW OF COMPLEXITY | LINE: 45 | Cyclomatic complexity is 12 (Limit: 8)
```

Target violation output:
```
FILE: src/foo.rs | LAW OF COMPLEXITY | LINE: 45
Function `process_request` has cyclomatic complexity 12 (Limit: 8)

ANALYSIS:
├── Branch at line 47: if validation_failed
├── Branch at line 52: if user.is_admin  
├── Branch at line 61: match request.method
│   ├── Arm: GET (line 62)
│   ├── Arm: POST (line 67)
│   └── Arm: _ (line 72)
└── Loop at line 78: for item in items

SUGGESTION: Extract validation logic (lines 47-58) into validate_request() function.
```

**Implementation approach:**

1. **Enhance AST analysis** to capture:
   - Function name where violation occurs
   - Line numbers of each branch/loop contributing to complexity
   - Nesting structure

2. **Add suggestion generation:**
   - For complexity: identify extractable blocks
   - For atomicity: identify logical boundaries for splitting
   - For paranoia: show the specific unwrap/expect call

**Files to modify:**
- `src/analysis/checks.rs` — enhance violation capture
- `src/types.rs` — extend `Violation` struct with richer data
- `src/reporting.rs` — format prescriptive output

**Acceptance Criteria:**
- Complexity violations show which branches contribute
- Atomicity violations suggest split points
- Paranoia violations show the exact call site
- Output is copy-pasteable to AI for actionable fixes

---

## Task 8: Harden TypeScript Import Resolution

**Priority:** Medium  
**Effort:** Medium-Large

TypeScript import resolution is complex:
- Relative imports (`./foo`, `../bar`)
- Bare specifiers (`lodash`)
- Path aliases (`@/components/Button`)
- Index files (`./utils` → `./utils/index.ts`)
- Extension resolution (`.ts`, `.tsx`, `.js`, `.jsx`)

**Current state:** Basic resolution exists but may not handle all cases.

**Files:**
- `src/graph/resolver.rs` — import path resolution
- `src/lang/typescript.rs` — TS-specific queries

**Approach:**
1. Audit current resolver against real TS projects
2. Add support for `tsconfig.json` path aliases
3. Handle index file resolution
4. Add tests for edge cases

**Acceptance Criteria:**
- Locality scanning works correctly on a real TypeScript project
- Path aliases are resolved
- Index files are found

---

## Task 9: Mark Experimental Commands

**Priority:** Low  
**Effort:** Trivial

Add `[EXPERIMENTAL]` prefix or similar to help output for:
- `audit`
- `map`  
- `signatures`
- `scan --locality`

**Files:**
- `src/cli/mod.rs` — update help strings

---

# Section 4: Execution Order

```
Phase 1: Self-Compliance (BLOCKING)
├── Task 1: Fix parser.rs violation

Phase 2: Surface Reduction
├── Task 2: Delete trace module
├── Task 3: Delete fix command
├── Task 4: Delete prompt command
├── Task 5: Delete/reduce dashboard

Phase 3: Stabilization
├── Task 6: Set locality to advisory mode
├── Task 9: Mark experimental commands

Phase 4: Enhancement
├── Task 7: Make violations prescriptive
├── Task 8: Harden TypeScript support
```

**Phase 1 must complete before any public release or posting.**

---

# Section 5: Testing Strategy

## 5.1 Existing Tests

The codebase has unit tests scattered through modules. Run with:
```bash
cargo test
```

## 5.2 Integration Testing

After each task, verify:
```bash
slopchop scan          # Should pass (no violations)
slopchop check         # Should pass (runs cargo test + scan)
```

## 5.3 Manual Verification

For deleted commands, verify they no longer appear:
```bash
slopchop --help        # trace, fix, prompt, dashboard should be gone
slopchop trace         # Should error "unknown command"
```

---

# Section 6: Files Quick Reference

## Files to Delete
```
src/trace/mod.rs
src/trace/options.rs
src/trace/output.rs
src/trace/runner.rs
src/tui/              # entire directory (if deleting dashboard)
```

## Files to Modify (High Touch)
```
src/apply/parser.rs      # Split to fix violation
src/cli/mod.rs           # Remove commands
src/cli/handlers.rs      # Remove handlers
src/lib.rs               # Remove module declarations
src/bin/slopchop.rs      # Remove command dispatch
src/config/mod.rs        # Change locality default
```

## Files to Modify (Enhancement)
```
src/analysis/checks.rs   # Prescriptive violations
src/types.rs             # Richer Violation struct
src/reporting.rs         # Better formatting
src/graph/resolver.rs    # TS import resolution
```

---

# Section 7: Success Criteria

v1.3 is complete when:

1. ✅ `slopchop scan` on SlopChop itself returns zero violations
2. ✅ Commands `trace`, `fix`, `prompt` no longer exist
3. ✅ Dashboard is deleted or minimal
4. ✅ Locality defaults to `mode = "warn"`
5. ✅ Violation output includes analysis and suggestions
6. ✅ TypeScript projects scan correctly for locality
7. ✅ All tests pass
8. ✅ `cargo clippy` passes with no warnings

---

# Section 8: Context for AI Execution

## 8.1 The SlopChop Protocol

When generating code changes, use this format:

```
XSC7XSC PLAN XSC7XSC
GOAL: <what you're doing>
CHANGES: <list of changes>
XSC7XSC END XSC7XSC

XSC7XSC MANIFEST XSC7XSC
path/to/modified/file.rs
path/to/new/file.rs [NEW]
path/to/deleted/file.rs [DELETE]
XSC7XSC END XSC7XSC

XSC7XSC FILE XSC7XSC path/to/file.rs
// complete file content
XSC7XSC END XSC7XSC
```

## 8.2 Constraints to Respect

- Files must be < 2000 tokens
- Cyclomatic complexity ≤ 8
- Nesting depth ≤ 3  
- Function arguments ≤ 5
- No `.unwrap()` or `.expect()` in production code (tests are exempt)
- Use `Result` types for error handling

## 8.3 Running Verification

After generating changes:
```bash
slopchop apply           # Apply to stage
slopchop check           # Verify (must pass)
slopchop apply --promote # Commit to workspace
```

## 8.4 If Verification Fails

The output will show violations. Address each one:
- **Atomicity:** Split the file into smaller modules
- **Complexity:** Extract functions, flatten logic
- **Paranoia:** Replace `.unwrap()` with proper error handling

---

# Appendix A: Command Reference (Post-v1.3)

## Core Commands

```bash
slopchop scan                    # Check for violations
slopchop scan --locality         # Include topology check (advisory)
slopchop check                   # Run full verification pipeline
slopchop apply                   # Apply changes to stage
slopchop apply --promote         # Commit staged changes
slopchop apply --reset           # Clear stage
slopchop pack                    # Generate full context
slopchop pack --focus <file>     # Generate focused context
slopchop pack --prompt           # Include system prompt
```

## Experimental Commands

```bash
slopchop audit                   # Find code duplication [EXPERIMENTAL]
slopchop map                     # Show repo structure [EXPERIMENTAL]
slopchop signatures              # Generate type maps [EXPERIMENTAL]
```

---

# Appendix B: Configuration Reference

```toml
# slopchop.toml

[rules]
max_file_tokens = 2000
max_cyclomatic_complexity = 8
max_nesting_depth = 3
max_function_args = 5

[rules.locality]
mode = "warn"              # "warn" | "error" | "off"
max_distance = 4
hub_threshold = 1.0

[commands]
check = [
    "cargo clippy --all-targets -- -D warnings",
    "cargo test",
]

[preferences]
auto_copy = true
backup_retention = 5
```
