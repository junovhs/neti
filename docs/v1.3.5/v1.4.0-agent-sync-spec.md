# SlopChop v1.4.0: Agentic Stage & Nuclear Sync

**Status:** Active Specification  
**Goal:** Enable a zero-friction, direct-edit workflow for AI Agents using a safe staging sandbox.

## 1. The Core Workflow (The "Loop")
The user (Blind Master) provides high-level intent. The Agent performs the work in a isolated sandbox.
1.  **Init:** `slopchop stage` creates the sandbox.
2.  **Edit:** Agent edits files in `.slopchop/stage/worktree/`.
3.  **Check:** Agent runs `slopchop check` to verify against the "3 Laws."
4.  **Sync:** Agent runs `slopchop apply --sync` to promote changes to the real repo.

---

## 2. Feature A: The `stage` Command
This is the "Front Door" for the agent. It prepares the shadow worktree.

*   **Behavior:** 
    1.  Check if `.slopchop/stage/worktree` exists.
    2.  If it exists: Prompt "Existing stage will be wiped. Proceed? [y/N]". (Allow `--force` to skip).
    3.  Execution: Run `stage.reset()` followed by `stage.create_stage()`.
    4.  Result: A fresh copy of the repository is mirrored into the stage, ready for direct editing.

---

## 3. Feature B: The "Nuclear Sync" (`apply --sync`)
This is the "Back Door." It mirrors the sandbox to the real workspace.

*   **Mechanism:** `src/stage/sync.rs`
*   **Logic:**
    1.  **Mirror:** Overwrite all files in root `./` with their versions from `.slopchop/stage/worktree/`.
    2.  **Prune:** Delete files in root that do not exist in the stage.
*   **Infrastructure Protection (Critical Exclusions):** 
    Never delete or overwrite: `.git/`, `.slopchop/`, `target/`, `node_modules/`, `.env`, `.vscode/`, `.idea/`.
*   **Self-Destruct:** After a successful sync, automatically run `reset()` on the stage.

---

## 4. Feature C: Heuristic Nudging (The "Nag")
Enforce "Iterative Discipline" via terminal feedback during the `check` command.

*   **Modification Detection:** Inside `handle_check`, if a stage exists, compare the file count between stage and root.
*   **Threshold:** If modified files > 3.
*   **Action:** Print a prominent [ADVISORY] block at the end of the `check` output suggesting the AI wrap up and sync to maintain high-integrity.

---

## 5. Feature D: Snapshot Documentation Protocol
The project now uses a "Snapshot" model for history to minimize AI context bloat.

*   **Canonical Docs:** Only active files live in the root of `docs/` (e.g., `past-present-future.md`).
*   **Archive:** All previous version notes live in `docs/archived/vX.Y.Z/`.
*   **Exclusion:** `.slopchopignore` must ensure `docs/archived/` is hidden from the AI during `pack`.
*   **Literate Code:** All feature descriptions must be moved from separate markdown files into the code using `//!` (module) and `///` (function) comments.

---

## 6. Technical Implementation Notes (For the Coding Agent)
1.  **No Diff Engine:** Do not attempt to calculate complex diffs for promotion. Use a raw filesystem mirror for `--sync`.
2.  **Safety:** The `should_preserve` list in `sync.rs` is the most important part of the code. If it fails, the user's `.git` history could be erased.
3.  **Direct Execution:** The agent is allowed to run `cargo install --path . --force` to test its own implementation of the `stage` and `sync` commands.

---

### End of Specification. 
**Coding Agent:** Implement these features in order (Stage -> Sync -> Nudge) and ensure the documentation is updated to reflect v1.4.0 as "Active."
